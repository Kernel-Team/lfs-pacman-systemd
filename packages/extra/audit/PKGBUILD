#-*-mode:sh-*-
# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer : Christian Rebischke <Chris.Rebischke@archlinux.org>
# Contributor: Daniel Micay <danielmicay@gmail.com>
# Contributor: <kang@insecure.ws>
# Contributor: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Contributor: Connor Behan <connor.behan@gmail.com>
# Contributor: henning mueller <henning@orgizm.net>
# Contributor: alexforsale@yahoo.com
pkgbase=audit
pkgname=('audit')
pkgver=2.8.5
pkgrel=1
pkgdesc='Userspace components of the audit framework'
url='https://people.redhat.com/sgrubb/audit'
arch=('x86_64')
makedepends=('krb5' 'libcap-ng' 'libldap' 'swig' 'linux-headers' 'python')
license=('GPL')
options=('emptydirs')
source=(${pkgbase}-${pkgver}.tar.gz::https://people.redhat.com/sgrubb/audit/${pkgbase}-${pkgver}.tar.gz)
sha512sums=('7d416aaa21c1a167f8e911ca82aecbaba804424f3243f505066c43ecc4a62a34feb2c27555e99d3268608404793dccca0f828c63670e3aa816016fb493f8174a')
groups=('extra')

if [[ $(pacman -Qq audit 2>/dev/null) ]];then
    pkgname+=( 'python-audit')
    pkgrel=$((pkgrel+1))
fi

prepare() {
    cd ${pkgbase}-${pkgver}
    sed 's|/var/run/auditd.pid|/run/auditd.pid|' -i init.d/auditd.service
    ./configure \
        --prefix=/usr/local \
        --sysconfdir=/usr/local/etc \
        --libexecdir=/usr/local/lib/audit \
        --enable-gssapi-krb5=yes \
        --enable-systemd=yes \
        --with-libcap-ng=yes
}

build() {
    cd ${pkgbase}-${pkgver}
    make
    [ -n "${SOURCE_DATE_EPOCH}" ] && touch -h -d @$SOURCE_DATE_EPOCH bindings/swig/python/audit.py
}

package_audit() {
    depends=('krb5' 'libcap-ng')
    provides=('libaudit.so' 'libauparse.so')
    backup=(
        etc/local/libaudit.conf
        etc/local/audit/audit-stop.rules
        etc/local/audit/auditd.conf
        etc/local/audisp/audispd.conf
        etc/local/audisp/audisp-remote.conf
        etc/local/audisp/zos-remote.conf
        etc/local/audisp/plugins.d/af_unix.conf
        etc/local/audisp/plugins.d/audispd-zos-remote.conf
        etc/local/audisp/plugins.d/au-remote.conf
        etc/local/audisp/plugins.d/syslog.conf
    )

    cd ${pkgbase}-${pkgver}
    make DESTDIR="${pkgdir}" INSTALL='install -p' install

    cd "${pkgdir}"
    install -d -m 0700 var/log/audit
    rm -rf etc/local/rc.d \
       etc/local/sysconfig \
       usr/local/lib/audit \
       usr/local/lib/python*

    chmod 644 usr/lib/systemd/system/auditd.service
    install -vdm755 ${pkgdir}/lib
    mv -v ${pkgdir}/usr/lib/systemd/ ${pkgdir}/lib/
    rm -rfv ${pkgdir}/usr/lib/systemd
    rm -rf ${pkgdir}/usr/local/lib/golang/src/pkg/redhat.com/audit/audit.go

    install -vdm755 ${pkgdir}/etc/local
    mv -v ${pkgdir}/usr/local/etc/* ${pkgdir}/etc/local
    rm -rfv ${pkgdir}/usr/local/etc/
}

package_python-audit() {
    depends=('python' 'audit')
    pkgdesc+=' (python bindings)'
    cd ${pkgbase}-${pkgver}
    make -C bindings DESTDIR="${pkgdir}" INSTALL='install -p' install

    mv -v ${pkgdir}/usr/local/* ${pkgdir}/usr
    rm -rfv ${pkgdir}/usr/local
}
