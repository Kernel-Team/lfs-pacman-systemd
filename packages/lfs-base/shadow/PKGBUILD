#-*-mode:sh-*-
# Maintainer: alexforsale@yahoo.com
pkgname=shadow
pkgver=4.7
pkgrel=1
pkgdesc="Password and account management tool suite with support for shadow files and PAM"
arch=('x86_64')
url='https://github.com/shadow-maint/shadow'
license=('BSD')
_deps=('bash' 'linux-pam' 'cracklib' 'acl' 'audit')
depends=()
groups=('lfs-base' 'security')
_makedeps=('libxslt' 'docbook-xsl' 'gnome-doc-utils')
makedepends=()
options=(strip)
install='shadow.install'
validpgpkeys=('D5C2F9BFCA128BBA22A77218872F702C4D6E25A8')  # Christian Perrier
source=(https://github.com/shadow-maint/shadow/releases/download/${pkgver}/${pkgname}-${pkgver}.tar.xz
        defaults.pam
        login
        su
        passwd
        shadow.{timer,service}
        useradd.defaults
        LICENSE
       )

for d in ${_deps[@]};do
    if [[ $(pacman -Ss ^${d}$ 2>/dev/null) ]];then
        depends+=( "$d")
        pkgrel=$((pkgrel+1))
    else
        optdepends+=( "$d")
    fi
done

if [[ "$(pacman -Qq linux-pam 2>/dev/null)" ]];then
    backup=(etc/login.defs
            etc/pam.d/{chage,passwd,shadow,useradd,usermod,userdel}
            etc/pam.d/{newusers,groupadd,groupdel,groupmod}
            etc/pam.d/groupmems
            etc/default/useradd)
fi

for m in ${_makedeps[@]};do
    if [[ $(pacman -Ss ^${m}$ 2>/dev/null) ]];then
        makedepends+=( "$m")
    else
        optdepends+=( "$m")
    fi
done
    
prepare() {
    cd "$pkgname"-"$pkgver"

    # need to offer these upstream
    #patch -Np1 <"$srcdir/xstrdup.patch"
    #patch -Np1 <"$srcdir/shadow-strncpy-usage.patch"

    # supress etc/pam.d/*, we provide our own
    sed -i '/^SUBDIRS/s/pam\.d//' etc/Makefile.in

    # Disable the installation of the groups program and its man pages, as Coreutils provides a better version.
    # Also Prevent the installation of manual pages that were already installed by the man pages package
    sed -i 's/groups$(EXEEXT) //' src/Makefile.in
    find man -name Makefile.in -exec sed -i 's/groups\.1 / /' {} \;
    find man -name Makefile.in -exec sed -i 's/getspnam\.3 / /' {} \;
    find man -name Makefile.in -exec sed -i 's/passwd\.5 / /' {} \;

    # use the more secure SHA-512 method of password encryption, which also allows passwords longer than 8 characters.
    # It is also necessary to change the obsolete /var/spool/mail location for user mailboxes that
    # Shadow uses by default to the /var/mail location used currently
    sed -i -e 's@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@' \
        -e 's@/var/spool/mail@/var/mail@' etc/login.defs

    # a minor change to make the first group number generated by useradd 1000
    sed -i 's/1000/999/' etc/useradd
    
    _confargs=()

    if [[ "$(pacman -Qq cracklib 2>/dev/null)" ]];then
        sed -i 's@DICTPATH.*@DICTPATH\t/lib/cracklib/pw_dict@' etc/login.defs
        _confargs+=( '--with-libcrack')
    fi

    if [[ "$(pacman -Qq linux-pam 2>/dev/null)" ]];then
        _confargs+=( '--with-libpam')
    else
        _confargs+=( '--without-libpam')
    fi
    
    if [[ "$(pacman -Qq gnome-doc-utils 2>/dev/null)" ]];then
        _confargs+=( '--enable-man')
    else
        _confargs+=( '--disable-man')
    fi

    if [[ "$(pacman -Qq audit 2>/dev/null)" ]];then
        _confargs+=( '--with-audit')
    fi

    ./configure \
        LIBS="-lcrypt" \
        --sysconfdir=/etc \
        --with-group-name-max-length=32 \
        ${_confargs[@]}
}

build() {
    cd "$pkgname"-"$pkgver"
    make
}

package() {
    cd "$pkgname"-"$pkgver"

    make DESTDIR="$pkgdir" install

    install -Dm644 "$srcdir/LICENSE" "$pkgdir/usr/share/licenses/shadow/LICENSE"

    install -v -dm755 "$pkgdir"/bin
    mv -v "$pkgdir"/usr/bin/passwd "$pkgdir"/bin

    if [[ "$(pacman -Qq linux-pam 2>/dev/null)" ]];then
        # useradd defaults
        install -Dm644 "$srcdir/useradd.defaults" "$pkgdir/etc/default/useradd"

        # systemd timer
        install -D -m644 "$srcdir/shadow.timer" "$pkgdir/lib/systemd/system/shadow.timer"
        install -D -m644 "$srcdir/shadow.service" "$pkgdir/lib/systemd/system/shadow.service"
        install -d -m755 "$pkgdir/lib/systemd/system/timers.target.wants"
        ln -sv ../shadow.timer "$pkgdir/lib/systemd/system/timers.target.wants/shadow.timer"

        # PAM config - custom
        install -dm755 "$pkgdir/etc/pam.d"
        install -t "$pkgdir/etc/pam.d" -m644 "$srcdir"/{passwd,login,su}

        # PAM config - from tarball
        install -Dm644 etc/pam.d/groupmems "$pkgdir/etc/pam.d/groupmems"

        # we use the 'useradd' PAM file for other similar utilities
        for file in chage chfn groupadd groupdel groupmod shadow \
                          useradd usermod userdel; do
            install -Dm644 "$srcdir/defaults.pam" "$pkgdir/etc/pam.d/$file"
        done
    fi
}

md5sums=('f7ce18c8dfd05f1a009266cb604d58b7'
         '41f81e9307110ff0e2bf32f50ecb1fe0'
         '53c9b49c843338fdef1f6d2364cb6a3a'
         '09a07847015540190e8faf6aedb417e5'
         'a205549bec2e6990af562d02b3fc3298'
         '5bd14862ace022d6682b179c18fe30de'
         '8547f55c4d9af64839bb6bbd928bbb70'
         'dbdecf31dbf18389bd80051f2aa372dc'
         '2cbe0684d1329e9c7f5a4c7cb01d239f')
